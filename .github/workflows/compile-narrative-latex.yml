# =============================================================================
# GitHub Actions Workflow: Compile Narrative FFGFT LaTeX Documents
# =============================================================================
# This workflow compiles all narrative LaTeX documents in /2/narrative/
# (both German and English versions) using full TeXLive distribution.
#
# Compiles:
# - 44 individual chapters (Kapitel_01-44_Narrative_De.tex and _En.tex)
# - Master documents (FFGFT_Narrative_Master_De.tex and _En.tex)
#
# Strategy:
# - Use xu-cheng/latex-action@v3 for comprehensive LaTeX support
# - Recursive compilation with latexmk (automatic multiple passes)
# - Error detection and reporting
# - Generate PDFs and upload as artifacts
# =============================================================================

name: Compile Narrative LaTeX

on:
  push:
    branches:
      - main
      - copilot/create-narrative-ffgft-publication
    paths:
      - '2/narrative/**/*.tex'
      - '.github/workflows/compile-narrative-latex.yml'
  pull_request:
    branches:
      - main
    paths:
      - '2/narrative/**/*.tex'
      - '.github/workflows/compile-narrative-latex.yml'
  workflow_dispatch:

jobs:
  compile-german-chapters:
    runs-on: ubuntu-latest
    name: Compile German Chapters
    strategy:
      fail-fast: false
      matrix:
        chapter: [01, 02, 03, 04, 05, 06, 07, 08, 09, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Compile Chapter ${{ matrix.chapter }}
        uses: xu-cheng/latex-action@v3
        with:
          working_directory: 2/narrative
          root_file: Kapitel_${{ matrix.chapter }}_Narrative_De.tex
          args: -pdf -interaction=nonstopmode -synctex=1 -file-line-error
          latexmk_use_lualatex: false
          latexmk_use_xelatex: false
          latexmk_shell_escape: false
        continue-on-error: true
      
      - name: Check compilation result and analyze errors
        if: always()
        run: |
          if [ -f "2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_De.pdf" ]; then
            echo "âœ… Chapter ${{ matrix.chapter }} compiled successfully"
            PDF_SIZE=$(du -h "2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_De.pdf" | cut -f1)
            echo "ðŸ“„ PDF size: $PDF_SIZE"
            echo "CHAPTER_${{ matrix.chapter }}_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ Chapter ${{ matrix.chapter }} failed to compile"
            echo "CHAPTER_${{ matrix.chapter }}_STATUS=failed" >> $GITHUB_ENV
            if [ -f "2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_De.log" ]; then
              echo ""
              echo "=== Error Analysis ==="
              echo "Searching for common LaTeX errors..."
              
              # Check for specific error patterns
              if grep -q "Undefined control sequence" "2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_De.log"; then
                echo "âš ï¸  Found: Undefined control sequence (missing command or package)"
                grep -A 2 "Undefined control sequence" "2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_De.log" | head -10
              fi
              
              if grep -q "Package.*not found" "2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_De.log"; then
                echo "âš ï¸  Found: Missing LaTeX package"
                grep "Package.*not found" "2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_De.log"
              fi
              
              if grep -q "File.*not found" "2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_De.log"; then
                echo "âš ï¸  Found: Missing file"
                grep "File.*not found" "2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_De.log"
              fi
              
              if grep -q "LaTeX Error" "2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_De.log"; then
                echo "âš ï¸  Found: LaTeX Error"
                grep -A 3 "LaTeX Error" "2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_De.log" | head -15
              fi
              
              echo ""
              echo "=== Last 100 lines of log file ==="
              tail -n 100 "2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_De.log"
            fi
          fi
      
      - name: Upload Chapter PDF
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: narrative-german-chapter-${{ matrix.chapter }}
          path: 2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_De.pdf
          if-no-files-found: warn
          retention-days: 30
      
      - name: Upload compilation log (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: narrative-german-chapter-${{ matrix.chapter }}-log
          path: 2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_De.log
          if-no-files-found: warn
          retention-days: 7

  compile-german-master:
    runs-on: ubuntu-latest
    name: Compile German Master Document
    needs: compile-german-chapters
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Compile German Master (recursive with latexmk)
        uses: xu-cheng/latex-action@v3
        with:
          working_directory: 2/narrative
          root_file: FFGFT_Narrative_Master_De.tex
          args: -pdf -interaction=nonstopmode -synctex=1 -file-line-error
          latexmk_use_lualatex: false
          latexmk_use_xelatex: false
          latexmk_shell_escape: false
        continue-on-error: true
      
      - name: Check Master compilation result
        if: always()
        run: |
          if [ -f "2/narrative/FFGFT_Narrative_Master_De.pdf" ]; then
            echo "âœ… German Master document compiled successfully"
            PDF_SIZE=$(du -h "2/narrative/FFGFT_Narrative_Master_De.pdf" | cut -f1)
            echo "ðŸ“„ PDF size: $PDF_SIZE"
            echo "MASTER_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ German Master document failed to compile"
            echo "MASTER_STATUS=failed" >> $GITHUB_ENV
            if [ -f "2/narrative/FFGFT_Narrative_Master_De.log" ]; then
              echo "=== Last 100 lines of log file ==="
              tail -n 100 "2/narrative/FFGFT_Narrative_Master_De.log"
              echo ""
              echo "=== Searching for errors in log ==="
              grep -i "error\|fatal\|emergency stop" "2/narrative/FFGFT_Narrative_Master_De.log" || true
            fi
          fi
      
      - name: Upload German Master PDF
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: narrative-german-master
          path: 2/narrative/FFGFT_Narrative_Master_De.pdf
          if-no-files-found: warn
          retention-days: 90
      
      - name: Upload Master compilation log (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: narrative-german-master-log
          path: 2/narrative/FFGFT_Narrative_Master_De.log
          if-no-files-found: warn
          retention-days: 7

  compile-english-chapters:
    runs-on: ubuntu-latest
    name: Compile English Chapters (if exist)
    strategy:
      fail-fast: false
      matrix:
        chapter: [01, 02, 03, 04, 05, 06, 07, 08, 09, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Check if English chapter exists
        id: check-file
        run: |
          if [ -f "2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_En.tex" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Found English Chapter ${{ matrix.chapter }}"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  Skipping English Chapter ${{ matrix.chapter }} (not found)"
          fi
      
      - name: Compile English Chapter ${{ matrix.chapter }}
        if: steps.check-file.outputs.exists == 'true'
        uses: xu-cheng/latex-action@v3
        with:
          working_directory: 2/narrative
          root_file: Kapitel_${{ matrix.chapter }}_Narrative_En.tex
          args: -pdf -interaction=nonstopmode -synctex=1 -file-line-error
          latexmk_use_lualatex: false
          latexmk_use_xelatex: false
          latexmk_shell_escape: false
        continue-on-error: true
      
      - name: Check compilation result and analyze errors
        if: steps.check-file.outputs.exists == 'true' && always()
        run: |
          if [ -f "2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_En.pdf" ]; then
            echo "âœ… English Chapter ${{ matrix.chapter }} compiled successfully"
            PDF_SIZE=$(du -h "2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_En.pdf" | cut -f1)
            echo "ðŸ“„ PDF size: $PDF_SIZE"
          else
            echo "âŒ English Chapter ${{ matrix.chapter }} failed to compile"
            if [ -f "2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_En.log" ]; then
              echo ""
              echo "=== Error Analysis ==="
              echo "Searching for common LaTeX errors..."
              
              # Check for specific error patterns
              if grep -q "Undefined control sequence" "2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_En.log"; then
                echo "âš ï¸  Found: Undefined control sequence"
                grep -A 2 "Undefined control sequence" "2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_En.log" | head -10
              fi
              
              if grep -q "Package.*not found" "2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_En.log"; then
                echo "âš ï¸  Found: Missing LaTeX package"
                grep "Package.*not found" "2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_En.log"
              fi
              
              if grep -q "LaTeX Error" "2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_En.log"; then
                echo "âš ï¸  Found: LaTeX Error"
                grep -A 3 "LaTeX Error" "2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_En.log" | head -15
              fi
              
              echo ""
              echo "=== Last 100 lines of log file ==="
              tail -n 100 "2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_En.log"
            fi
          fi
      
      - name: Upload English Chapter PDF
        if: steps.check-file.outputs.exists == 'true' && success()
        uses: actions/upload-artifact@v4
        with:
          name: narrative-english-chapter-${{ matrix.chapter }}
          path: 2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_En.pdf
          if-no-files-found: warn
          retention-days: 30
      
      - name: Upload compilation log (on failure)
        if: steps.check-file.outputs.exists == 'true' && failure()
        uses: actions/upload-artifact@v4
        with:
          name: narrative-english-chapter-${{ matrix.chapter }}-log
          path: 2/narrative/Kapitel_${{ matrix.chapter }}_Narrative_En.log
          if-no-files-found: warn
          retention-days: 7

  compile-english-master:
    runs-on: ubuntu-latest
    name: Compile English Master Document (if exists)
    needs: compile-english-chapters
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Check for English master
        id: check-master
        run: |
          if [ -f "2/narrative/FFGFT_Narrative_Master_En.tex" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Found English Master document"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  No English master document found - skipping compilation"
          fi
      
      - name: Compile English Master (recursive with latexmk)
        if: steps.check-master.outputs.exists == 'true'
        uses: xu-cheng/latex-action@v3
        with:
          working_directory: 2/narrative
          root_file: FFGFT_Narrative_Master_En.tex
          args: -pdf -interaction=nonstopmode -synctex=1 -file-line-error
          latexmk_use_lualatex: false
          latexmk_use_xelatex: false
          latexmk_shell_escape: false
        continue-on-error: true
      
      - name: Check Master compilation result
        if: steps.check-master.outputs.exists == 'true' && always()
        run: |
          if [ -f "2/narrative/FFGFT_Narrative_Master_En.pdf" ]; then
            echo "âœ… English Master document compiled successfully"
            PDF_SIZE=$(du -h "2/narrative/FFGFT_Narrative_Master_En.pdf" | cut -f1)
            echo "ðŸ“„ PDF size: $PDF_SIZE"
          else
            echo "âŒ English Master document failed to compile"
            if [ -f "2/narrative/FFGFT_Narrative_Master_En.log" ]; then
              echo "=== Last 100 lines of log file ==="
              tail -n 100 "2/narrative/FFGFT_Narrative_Master_En.log"
              echo ""
              echo "=== Searching for errors in log ==="
              grep -i "error\|fatal\|emergency stop" "2/narrative/FFGFT_Narrative_Master_En.log" || true
            fi
          fi
      
      - name: Upload English Master PDF
        if: steps.check-master.outputs.exists == 'true' && success()
        uses: actions/upload-artifact@v4
        with:
          name: narrative-english-master
          path: 2/narrative/FFGFT_Narrative_Master_En.pdf
          if-no-files-found: warn
          retention-days: 90
      
      - name: Upload Master compilation log (on failure)
        if: steps.check-master.outputs.exists == 'true' && failure()
        uses: actions/upload-artifact@v4
        with:
          name: narrative-english-master-log
          path: 2/narrative/FFGFT_Narrative_Master_En.log
          if-no-files-found: warn
          retention-days: 7

  summary:
    runs-on: ubuntu-latest
    name: Build Summary
    needs: [compile-german-chapters, compile-german-master, compile-english-chapters, compile-english-master]
    if: always()
    
    steps:
      - name: Build Summary
        run: |
          echo "# ðŸ“Š LaTeX Compilation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Jobs Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| German Chapters | ${{ needs.compile-german-chapters.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| German Master | ${{ needs.compile-german-master.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| English Chapters | ${{ needs.compile-english-chapters.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| English Master | ${{ needs.compile-english-master.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Generated PDFs are available as workflow artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "- **German chapters**: 30 days retention" >> $GITHUB_STEP_SUMMARY
          echo "- **German master**: 90 days retention" >> $GITHUB_STEP_SUMMARY
          echo "- **English documents**: 30-90 days retention (if compiled)" >> $GITHUB_STEP_SUMMARY
          echo "- **Compilation logs**: 7 days retention (on failure)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## â„¹ï¸ Notes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Each chapter is compiled independently with recursive latexmk" >> $GITHUB_STEP_SUMMARY
          echo "- Multiple passes ensure proper cross-references and TOC" >> $GITHUB_STEP_SUMMARY
          echo "- Check individual job logs for detailed error messages" >> $GITHUB_STEP_SUMMARY
