<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Musikalische Œæ-FFT Analyse</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
            min-height: 100vh;
            color: #ecf0f1;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(52, 73, 94, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            border: 1px solid rgba(236, 240, 241, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #3498db;
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #3498db 0%, #9b59b6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.8;
            color: #bdc3c7;
        }

        .music-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        .music-card {
            background: rgba(236, 240, 241, 0.05);
            border: 2px solid rgba(52, 152, 219, 0.3);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .music-card:hover {
            border-color: #3498db;
            box-shadow: 0 10px 30px rgba(52, 152, 219, 0.2);
            transform: translateY(-5px);
        }

        .music-card h3 {
            color: #3498db;
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .note-selector {
            margin-bottom: 15px;
        }

        .note-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #ecf0f1;
            font-size: 0.95em;
        }

        select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(44, 62, 80, 0.9);
            border: 2px solid rgba(52, 152, 219, 0.3);
            border-radius: 8px;
            color: #ecf0f1;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        select option {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
        }

        button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
            min-width: 120px;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        button.secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            box-shadow: 0 4px 15px rgba(149, 165, 166, 0.3);
        }

        button.play-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }

        .chord-display {
            background: rgba(44, 62, 80, 0.8);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }

        .chord-notes {
            display: flex;
            justify-content: space-around;
            margin: 10px 0;
        }

        .note-box {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            min-width: 60px;
            box-shadow: 0 3px 10px rgba(155, 89, 182, 0.3);
        }

        .interval-info {
            font-size: 0.85em;
            color: #bdc3c7;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
        }

        .results {
            grid-column: 1 / -1;
            background: rgba(236, 240, 241, 0.05);
            border: 2px solid rgba(52, 152, 219, 0.3);
            border-radius: 15px;
            padding: 30px;
            margin-top: 20px;
        }

        .results h3 {
            color: #3498db;
            margin-bottom: 25px;
            font-size: 1.6em;
            text-align: center;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .analysis-card {
            background: rgba(44, 62, 80, 0.6);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #e74c3c;
        }

        .analysis-card.spectrum {
            border-left-color: #f39c12;
        }

        .analysis-card.xi-ratios {
            border-left-color: #2ecc71;
        }

        .analysis-card h4 {
            color: #ecf0f1;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .freq-list {
            list-style: none;
            max-height: 200px;
            overflow-y: auto;
        }

        .freq-list li {
            background: rgba(236, 240, 241, 0.1);
            margin: 5px 0;
            padding: 10px 12px;
            border-radius: 6px;
            border-left: 3px solid #3498db;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }

        .freq-list li:hover {
            background: rgba(52, 152, 219, 0.2);
            transform: translateX(5px);
        }

        .xi-list li {
            border-left-color: #2ecc71;
        }

        .canvas-container {
            margin: 20px 0;
            text-align: center;
            background: rgba(44, 62, 80, 0.4);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid rgba(52, 152, 219, 0.3);
        }

        .canvas-title {
            color: #3498db;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: 600;
        }

        canvas {
            border: 2px solid rgba(52, 152, 219, 0.3);
            border-radius: 8px;
            background: rgba(236, 240, 241, 0.95);
            display: block;
            margin: 0 auto;
            max-width: 100%;
        }

        .preset-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(44, 62, 80, 0.4);
            border-radius: 12px;
            border: 2px solid rgba(52, 152, 219, 0.3);
        }

        .preset-section h4 {
            color: #3498db;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .preset-grid button {
            font-size: 0.85em;
            padding: 10px 15px;
            min-width: auto;
        }

        @media (max-width: 1200px) {
            .music-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .music-grid {
                grid-template-columns: 1fr;
            }
            
            .analysis-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 20px;
            }
            
            .chord-notes {
                flex-direction: column;
                gap: 10px;
            }
            
            .note-box {
                margin: 0 auto;
            }
        }

        .frequency-display {
            font-family: 'Courier New', monospace;
            background: rgba(52, 152, 219, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
            margin: 5px 0;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        .xi-highlight {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéµ Musikalische Œæ-FFT Analyse</h1>
            <p>Erkunde Intervalle, Dreikl√§nge und Oktaven durch Frequenz-Verh√§ltnisse</p>
        </div>

        <div class="music-grid">
            <!-- Intervalle -->
            <div class="music-card">
                <h3>üéº Intervalle</h3>
                
                <div class="note-selector">
                    <label>Grundton:</label>
                    <select id="interval-root">
                        <option value="261.63">C4 (261.63 Hz)</option>
                        <option value="277.18">C#4 (277.18 Hz)</option>
                        <option value="293.66">D4 (293.66 Hz)</option>
                        <option value="311.13">D#4 (311.13 Hz)</option>
                        <option value="329.63">E4 (329.63 Hz)</option>
                        <option value="349.23">F4 (349.23 Hz)</option>
                        <option value="369.99">F#4 (369.99 Hz)</option>
                        <option value="392.00">G4 (392.00 Hz)</option>
                        <option value="415.30">G#4 (415.30 Hz)</option>
                        <option value="440.00" selected>A4 (440.00 Hz)</option>
                        <option value="466.16">A#4 (466.16 Hz)</option>
                        <option value="493.88">B4 (493.88 Hz)</option>
                    </select>
                </div>

                <div class="note-selector">
                    <label>Intervall:</label>
                    <select id="interval-type">
                        <option value="1.0">Unisono (1:1)</option>
                        <option value="1.125">Kleine Sekunde (16:15)</option>
                        <option value="1.2">Gro√üe Sekunde (6:5)</option>
                        <option value="1.25">Kleine Terz (5:4)</option>
                        <option value="1.333">Gro√üe Terz (4:3)</option>
                        <option value="1.414">Tritonus (‚àö2:1)</option>
                        <option value="1.5" selected>Quinte (3:2)</option>
                        <option value="1.667">Kleine Sexte (5:3)</option>
                        <option value="1.8">Gro√üe Sexte (9:5)</option>
                        <option value="1.875">Kleine Septime (15:8)</option>
                        <option value="1.9">Gro√üe Septime (19:10)</option>
                        <option value="2.0">Oktave (2:1)</option>
                    </select>
                </div>

                <button onclick="playInterval()" class="play-btn">üîä Abspielen</button>
                <button onclick="analyzeInterval()">üîç Analysieren</button>

                <div class="chord-display">
                    <div id="interval-display">
                        <div class="chord-notes">
                            <div class="note-box" id="interval-note1">A4</div>
                            <div class="note-box" id="interval-note2">E5</div>
                        </div>
                        <div class="interval-info" id="interval-info">
                            Quinte: 440.00 Hz ‚Üí 660.00 Hz<br>
                            Verh√§ltnis: 3:2 = 1.50<br>
                            Œæ-Ratio: <span class="xi-highlight">1.50</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dreikl√§nge -->
            <div class="music-card">
                <h3>üéπ Dreikl√§nge</h3>
                
                <div class="note-selector">
                    <label>Grundton:</label>
                    <select id="chord-root">
                        <option value="261.63">C4 (261.63 Hz)</option>
                        <option value="277.18">C#4 (277.18 Hz)</option>
                        <option value="293.66">D4 (293.66 Hz)</option>
                        <option value="311.13">D#4 (311.13 Hz)</option>
                        <option value="329.63">E4 (329.63 Hz)</option>
                        <option value="349.23">F4 (349.23 Hz)</option>
                        <option value="369.99">F#4 (369.99 Hz)</option>
                        <option value="392.00">G4 (392.00 Hz)</option>
                        <option value="415.30">G#4 (415.30 Hz)</option>
                        <option value="440.00" selected>A4 (440.00 Hz)</option>
                        <option value="466.16">A#4 (466.16 Hz)</option>
                        <option value="493.88">B4 (493.88 Hz)</option>
                    </select>
                </div>

                <div class="note-selector">
                    <label>Akkord-Typ:</label>
                    <select id="chord-type">
                        <option value="major" selected>Dur (1:5/4:3/2)</option>
                        <option value="minor">Moll (1:6/5:3/2)</option>
                        <option value="diminished">Vermindert (1:6/5:‚àö2)</option>
                        <option value="augmented">√úberm√§√üig (1:5/4:8/5)</option>
                        <option value="sus2">Sus2 (1:9/8:3/2)</option>
                        <option value="sus4">Sus4 (1:4/3:3/2)</option>
                        <option value="power">Power Chord (1:3/2)</option>
                    </select>
                </div>

                <button onclick="playChord()" class="play-btn">üîä Abspielen</button>
                <button onclick="analyzeChord()">üîç Analysieren</button>

                <div class="chord-display">
                    <div id="chord-display">
                        <div class="chord-notes">
                            <div class="note-box" id="chord-note1">A4</div>
                            <div class="note-box" id="chord-note2">C#5</div>
                            <div class="note-box" id="chord-note3">E5</div>
                        </div>
                        <div class="interval-info" id="chord-info">
                            A-Dur: 440.00 Hz - 550.00 Hz - 660.00 Hz<br>
                            Intervalle: Gro√üe Terz (5:4), Quinte (3:2)<br>
                            Œæ-Ratios: <span class="xi-highlight">1.25, 1.50, 1.20</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Oktaven -->
            <div class="music-card">
                <h3>üåà Oktaven & Harmonische</h3>
                
                <div class="note-selector">
                    <label>Grundfrequenz:</label>
                    <select id="fundamental">
                        <option value="55">A1 (55 Hz)</option>
                        <option value="110">A2 (110 Hz)</option>
                        <option value="220">A3 (220 Hz)</option>
                        <option value="440" selected>A4 (440 Hz)</option>
                        <option value="880">A5 (880 Hz)</option>
                    </select>
                </div>

                <div class="note-selector">
                    <label>Anzahl Harmonische:</label>
                    <select id="harmonics-count">
                        <option value="2">2 (Oktave)</option>
                        <option value="3">3 (Duodezime)</option>
                        <option value="4" selected>4 (Doppel-Oktave)</option>
                        <option value="5">5 (Gro√üe Terz + 2 Okt.)</option>
                        <option value="6">6 (Quinte + 2 Okt.)</option>
                        <option value="8">8 (Dreifach-Oktave)</option>
                    </select>
                </div>

                <button onclick="playHarmonics()" class="play-btn">üîä Abspielen</button>
                <button onclick="analyzeHarmonics()">üîç Analysieren</button>

                <div class="chord-display">
                    <div id="harmonics-display">
                        <div class="chord-notes" id="harmonics-notes">
                            <div class="note-box">440 Hz</div>
                            <div class="note-box">880 Hz</div>
                            <div class="note-box">1320 Hz</div>
                            <div class="note-box">1760 Hz</div>
                        </div>
                        <div class="interval-info" id="harmonics-info">
                            Harmonische Reihe von A4 (440 Hz)<br>
                            Verh√§ltnisse: 1:2:3:4<br>
                            Œæ-Ratios: <span class="xi-highlight">2.00, 3.00, 4.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preset-Sektion -->
        <div class="preset-section">
            <h4>üéØ Musikalische Presets</h4>
            <div class="preset-grid">
                <button onclick="loadPreset('perfect-fifth')">Reine Quinte</button>
                <button onclick="loadPreset('major-triad')">Dur-Dreiklang</button>
                <button onclick="loadPreset('minor-triad')">Moll-Dreiklang</button>
                <button onclick="loadPreset('octaves')">Oktaven</button>
                <button onclick="loadPreset('power-chord')">Power Chord</button>
                <button onclick="loadPreset('bach-chord')">Bach-Akkord</button>
                <button onclick="loadPreset('just-intonation')">Reine Stimmung</button>
                <button onclick="loadPreset('equal-temperament')">Gleichstufig</button>
            </div>
        </div>

        <!-- Ergebnisse -->
        <div class="results">
            <h3>üî¨ Œæ-FFT Musikalische Analyse</h3>
            
            <div class="canvas-container">
                <div class="canvas-title">Frequenzspektrum & Harmonische</div>
                <canvas id="musicCanvas" width="800" height="300"></canvas>
            </div>

            <div class="analysis-grid">
                <div class="analysis-card">
                    <h4>üéµ Erkannte Frequenzen</h4>
                    <ul id="frequencies-list" class="freq-list">
                        <li>W√§hle ein Intervall oder Akkord zum Analysieren...</li>
                    </ul>
                </div>
                
                <div class="analysis-card spectrum">
                    <h4>üìä Spektrum-Details</h4>
                    <div id="spectrum-details">
                        <div class="frequency-display">
                            <strong>Peaks:</strong> <span id="peak-count">--</span><br>
                            <strong>St√§rkste Frequenz:</strong> <span id="dominant-freq">--</span><br>
                            <strong>Grundton:</strong> <span id="fundamental-freq">--</span><br>
                            <strong>Komplexit√§t:</strong> <span id="spectrum-complexity">--</span>
                        </div>
                    </div>
                </div>
                
                <div class="analysis-card xi-ratios">
                    <h4>‚ö° Musikalische Œæ-Verh√§ltnisse</h4>
                    <ul id="xi-ratios-list" class="freq-list xi-list">
                        <li>Keine Œæ-Verh√§ltnisse berechnet...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Œæ-FFT Library (VOLLST√ÑNDIGE STANDALONE VERSION) -->
    <script>
        /**
         * Œæ-FFT JavaScript Library - VOLLST√ÑNDIGE VERSION
         * Spektralanalyse durch Frequenz-Verh√§ltnisse mit Integer-Arithmetik
         */

        // ===== HAUPT Œæ-FFT KLASSE =====
        class XiFFT {
            constructor(sampleRate, threshold = 0.02) {
                this.sampleRate = sampleRate;
                this.threshold = Math.floor(threshold * 1000);
                this.version = '1.0.0';
            }

            analyze(signal, freqRange = [10, 5000]) {
                if (!Array.isArray(signal) || signal.length === 0) {
                    throw new Error('Signal muss ein nicht-leeres Array sein');
                }

                const peaks = this.findSpectralPeaks(signal, freqRange);
                const xiRatios = this.calculateXiRatios(peaks);
                const signalStats = this.calculateSignalStats(signal);

                return {
                    peaks: peaks,
                    xiRatios: xiRatios,
                    dominantXi: xiRatios[0] || null,
                    peakCount: peaks.length,
                    complexity: xiRatios.length,
                    signalStats: signalStats,
                    analysisTime: Date.now(),
                    version: this.version
                };
            }

            findSpectralPeaks(signal, freqRange) {
                const peaks = [];
                const [minFreq, maxFreq] = freqRange;
                const stepSize = Math.max(1, Math.floor((maxFreq - minFreq) / 2000));

                for (let freq = minFreq; freq <= maxFreq; freq += stepSize) {
                    const magnitude = this.calculateMagnitude(signal, freq);
                    
                    if (magnitude > this.threshold) {
                        peaks.push({
                            frequency: freq,
                            magnitude: magnitude,
                            magnitudeFloat: magnitude / 1000.0
                        });
                    }
                }

                return peaks.sort((a, b) => b.magnitude - a.magnitude).slice(0, 25);
            }

            calculateMagnitude(signal, frequency) {
                const N = signal.length;
                let real = 0;
                let imag = 0;

                for (let n = 0; n < N; n++) {
                    const angle = -2 * Math.PI * frequency * n / this.sampleRate;
                    const cosVal = Math.cos(angle);
                    const sinVal = Math.sin(angle);
                    
                    real += (signal[n] / 1000.0) * cosVal;
                    imag += (signal[n] / 1000.0) * sinVal;
                }

                const magnitude = Math.sqrt(real * real + imag * imag) * 2 / N;
                return Math.floor(magnitude * 1000);
            }

            calculateXiRatios(peaks) {
                const ratios = [];

                for (let i = 0; i < peaks.length; i++) {
                    for (let j = i + 1; j < peaks.length; j++) {
                        const f1 = peaks[i].frequency;
                        const f2 = peaks[j].frequency;
                        
                        const freqHigh = Math.max(f1, f2);
                        const freqLow = Math.min(f1, f2);
                        
                        const xiRatio = Math.floor((freqHigh * 100) / freqLow);
                        const significance = Math.floor((peaks[i].magnitude * peaks[j].magnitude) / 1000);
                        
                        ratios.push({
                            freqHigh: freqHigh,
                            freqLow: freqLow,
                            xiRatio: xiRatio,
                            xiRatioFloat: xiRatio / 100.0,
                            significance: significance,
                            peakIndices: [i, j]
                        });
                    }
                }

                return ratios.sort((a, b) => b.significance - a.significance);
            }

            calculateSignalStats(signal) {
                let sum = 0;
                let sumSquares = 0;
                let minVal = signal[0];
                let maxVal = signal[0];

                for (let i = 0; i < signal.length; i++) {
                    const val = signal[i];
                    sum += val;
                    sumSquares += Math.floor((val * val) / 1000);
                    if (val < minVal) minVal = val;
                    if (val > maxVal) maxVal = val;
                }

                const mean = Math.floor(sum / signal.length);
                const variance = Math.floor(sumSquares / signal.length) - Math.floor((mean * mean) / 1000);
                const rms = Math.floor(Math.sqrt(Math.max(0, Math.floor(sumSquares / signal.length))));

                return {
                    mean: mean,
                    meanFloat: mean / 1000.0,
                    rms: rms,
                    rmsFloat: rms / 1000.0,
                    variance: Math.max(0, variance),
                    std: Math.floor(Math.sqrt(Math.max(0, variance))),
                    min: minVal,
                    max: maxVal,
                    range: maxVal - minVal,
                    sampleCount: signal.length
                };
            }
        }

        // ===== SIGNAL-GENERATOR KLASSE =====
        class XiSignal {
            static create(frequencies, amplitudes, duration = 2.0, sampleRate = 1000, noise = 0.0) {
                if (!Array.isArray(frequencies) || !Array.isArray(amplitudes)) {
                    throw new Error('Frequenzen und Amplituden m√ºssen Arrays sein');
                }
                if (frequencies.length !== amplitudes.length) {
                    throw new Error('Frequenzen und Amplituden m√ºssen gleiche L√§nge haben');
                }

                const samples = Math.floor(duration * sampleRate);
                const signal = [];

                for (let i = 0; i < samples; i++) {
                    const t = i / sampleRate;
                    let value = 0;

                    for (let j = 0; j < frequencies.length; j++) {
                        if (amplitudes[j] > 0) {
                            value += amplitudes[j] * Math.sin(2 * Math.PI * frequencies[j] * t);
                        }
                    }

                    if (noise > 0) {
                        value += noise * (Math.random() - 0.5) * 2;
                    }

                    signal.push(Math.floor(value * 1000));
                }

                return signal;
            }
        }

        // ===== MUSIKALISCHE HILFSFUNKTIONEN =====
        class XiMusic {
            static noteFrequencies = {
                'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'E4': 329.63, 'F4': 349.23,
                'F#4': 369.99, 'G4': 392.00, 'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88,
                'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25, 'E5': 659.25, 'F5': 698.46
            };

            static chords = {
                'major': { ratios: [1, 5/4, 3/2], name: 'Dur' },
                'minor': { ratios: [1, 6/5, 3/2], name: 'Moll' },
                'diminished': { ratios: [1, 6/5, Math.sqrt(2)], name: 'Vermindert' },
                'augmented': { ratios: [1, 5/4, 8/5], name: '√úberm√§√üig' },
                'sus2': { ratios: [1, 9/8, 3/2], name: 'Sus2' },
                'sus4': { ratios: [1, 4/3, 3/2], name: 'Sus4' },
                'power': { ratios: [1, 3/2], name: 'Power' }
            };

            static getNoteName(frequency) {
                // Einfache Noten-Erkennung
                const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                const A4 = 440;
                const semitoneRatio = Math.pow(2, 1/12);
                const semitonesFromA4 = Math.round(12 * Math.log2(frequency / A4));
                const octave = 4 + Math.floor(semitonesFromA4 / 12);
                const noteIndex = ((semitonesFromA4 % 12) + 9 + 12) % 12;  // A = 9
                return noteNames[noteIndex] + octave;
            }
        }

        // ===== MUSIKALISCHE ANWENDUNG =====
        
        // Globale Variablen
        let xiFFT = new XiFFT(1000, 0.01);
        let audioContext;
        let currentAnalysis = null;

        // Audio-Funktionen
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function getNoteName(frequency) {
            return XiMusic.getNoteName(frequency);
        }

        const chordDefinitions = XiMusic.chords;

        function playTone(frequency, duration = 1.0, volume = 0.3) {
            initAudioContext();
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        function playChordTones(frequencies, duration = 2.0) {
            frequencies.forEach(freq => {
                playTone(freq, duration, 0.2);
            });
        }

        // Intervall-Funktionen
        function updateIntervalDisplay() {
            const root = parseFloat(document.getElementById('interval-root').value);
            const intervalRatio = parseFloat(document.getElementById('interval-type').value);
            const second = root * intervalRatio;
            
            document.getElementById('interval-note1').textContent = getNoteName(root);
            document.getElementById('interval-note2').textContent = getNoteName(second);
            
            const intervalName = document.getElementById('interval-type').selectedOptions[0].text;
            document.getElementById('interval-info').innerHTML = `
                ${intervalName}<br>
                ${root.toFixed(2)} Hz ‚Üí ${second.toFixed(2)} Hz<br>
                Verh√§ltnis: ${intervalRatio.toFixed(3)}<br>
                Œæ-Ratio: <span class="xi-highlight">${intervalRatio.toFixed(2)}</span>
            `;
        }

        function playInterval() {
            const root = parseFloat(document.getElementById('interval-root').value);
            const intervalRatio = parseFloat(document.getElementById('interval-type').value);
            const second = root * intervalRatio;
            
            playTone(root, 2.0, 0.3);
            setTimeout(() => playTone(second, 2.0, 0.3), 1000);
        }

        function analyzeInterval() {
            const root = parseFloat(document.getElementById('interval-root').value);
            const intervalRatio = parseFloat(document.getElementById('interval-type').value);
            const second = root * intervalRatio;
            
            const signal = XiSignal.create([root, second], [0.8, 0.8], 2.0, 1000);
            analyzeMusicalSignal(signal, [root, second]);
        }

        // Akkord-Funktionen
        function updateChordDisplay() {
            const root = parseFloat(document.getElementById('chord-root').value);
            const chordType = document.getElementById('chord-type').value;
            const ratios = chordDefinitions[chordType].ratios;
            
            const frequencies = ratios.map(ratio => root * ratio);
            const notes = frequencies.map(freq => getNoteName(freq));
            
            const noteElements = ['chord-note1', 'chord-note2', 'chord-note3'];
            noteElements.forEach((id, index) => {
                const element = document.getElementById(id);
                if (element) {
                    if (index < notes.length) {
                        element.textContent = notes[index];
                        element.style.display = 'block';
                    } else {
                        element.style.display = 'none';
                    }
                }
            });
            
            const chordName = document.getElementById('chord-type').selectedOptions[0].text;
            const freqText = frequencies.map(f => f.toFixed(2) + ' Hz').join(' - ');
            const ratioText = ratios.map(r => r.toFixed(3)).join(':');
            const xiRatios = [];
            
            for (let i = 0; i < frequencies.length; i++) {
                for (let j = i + 1; j < frequencies.length; j++) {
                    xiRatios.push((frequencies[j] / frequencies[i]).toFixed(2));
                }
            }
            
            document.getElementById('chord-info').innerHTML = `
                ${getNoteName(root)}-${chordName}<br>
                ${freqText}<br>
                Verh√§ltnisse: ${ratioText}<br>
                Œæ-Ratios: <span class="xi-highlight">${xiRatios.join(', ')}</span>
            `;
        }

        function playChord() {
            const root = parseFloat(document.getElementById('chord-root').value);
            const chordType = document.getElementById('chord-type').value;
            const ratios = chordDefinitions[chordType].ratios;
            const frequencies = ratios.map(ratio => root * ratio);
            
            playChordTones(frequencies, 3.0);
        }

        function analyzeChord() {
            const root = parseFloat(document.getElementById('chord-root').value);
            const chordType = document.getElementById('chord-type').value;
            const ratios = chordDefinitions[chordType].ratios;
            const frequencies = ratios.map(ratio => root * ratio);
            
            const amplitudes = new Array(frequencies.length).fill(0.7);
            const signal = XiSignal.create(frequencies, amplitudes, 2.0, 1000);
            analyzeMusicalSignal(signal, frequencies);
        }

        // Harmonische-Funktionen
        function updateHarmonicsDisplay() {
            const fundamental = parseFloat(document.getElementById('fundamental').value);
            const count = parseInt(document.getElementById('harmonics-count').value);
            
            const frequencies = [];
            for (let i = 1; i <= count; i++) {
                frequencies.push(fundamental * i);
            }
            
            const notesContainer = document.getElementById('harmonics-notes');
            notesContainer.innerHTML = '';
            
            frequencies.forEach(freq => {
                const noteBox = document.createElement('div');
                noteBox.className = 'note-box';
                noteBox.textContent = freq >= 1000 ? 
                    (freq / 1000).toFixed(1) + 'kHz' : 
                    freq.toFixed(0) + 'Hz';
                notesContainer.appendChild(noteBox);
            });
            
            const ratios = frequencies.map((f, i) => i + 1).join(':');
            const xiRatios = [];
            
            for (let i = 0; i < frequencies.length; i++) {
                for (let j = i + 1; j < frequencies.length; j++) {
                    xiRatios.push((frequencies[j] / frequencies[i]).toFixed(2));
                }
            }
            
            document.getElementById('harmonics-info').innerHTML = `
                Harmonische Reihe von ${getNoteName(fundamental)} (${fundamental} Hz)<br>
                Verh√§ltnisse: ${ratios}<br>
                Œæ-Ratios: <span class="xi-highlight">${xiRatios.slice(0, 6).join(', ')}</span>
            `;
        }

        function playHarmonics() {
            const fundamental = parseFloat(document.getElementById('fundamental').value);
            const count = parseInt(document.getElementById('harmonics-count').value);
            
            const frequencies = [];
            for (let i = 1; i <= count; i++) {
                frequencies.push(fundamental * i);
            }
            
            playChordTones(frequencies, 3.0);
        }

        function analyzeHarmonics() {
            const fundamental = parseFloat(document.getElementById('fundamental').value);
            const count = parseInt(document.getElementById('harmonics-count').value);
            
            const frequencies = [];
            const amplitudes = [];
            for (let i = 1; i <= count; i++) {
                frequencies.push(fundamental * i);
                amplitudes.push(0.8 / i);
            }
            
            const signal = XiSignal.create(frequencies, amplitudes, 2.0, 1000);
            analyzeMusicalSignal(signal, frequencies);
        }

        // Hauptanalyse-Funktion
        function analyzeMusicalSignal(signal, expectedFreqs) {
            try {
                currentAnalysis = xiFFT.analyze(signal, [20, 5000]);
                
                displayFrequencies(currentAnalysis.peaks, expectedFreqs);
                displaySpectrumDetails(currentAnalysis);
                displayXiRatios(currentAnalysis.xiRatios);
                plotSpectrum(currentAnalysis.peaks, expectedFreqs);
                
            } catch (error) {
                console.error('Analyse Fehler:', error);
            }
        }

        function displayFrequencies(peaks, expectedFreqs) {
            const list = document.getElementById('frequencies-list');
            list.innerHTML = '';
            
            if (!peaks || peaks.length === 0) {
                list.innerHTML = '<li>Keine Frequenzen erkannt</li>';
                return;
            }
            
            peaks.slice(0, 12).forEach(peak => {
                const li = document.createElement('li');
                const noteName = getNoteName(peak.frequency);
                const magnitude = (peak.magnitude / 1000).toFixed(3);
                
                const isExpected = expectedFreqs.some(f => Math.abs(f - peak.frequency) < 10);
                const style = isExpected ? 'style="border-left-color: #27ae60; background: rgba(46, 204, 113, 0.1);"' : '';
                
                li.innerHTML = `<span ${style}>${peak.frequency} Hz (${noteName}) - Amplitude: ${magnitude}</span>`;
                list.appendChild(li);
            });
        }

        function displaySpectrumDetails(analysis) {
            document.getElementById('peak-count').textContent = analysis.peakCount;
            
            if (analysis.peaks.length > 0) {
                const dominantPeak = analysis.peaks[0];
                document.getElementById('dominant-freq').textContent = 
                    `${dominantPeak.frequency} Hz (${getNoteName(dominantPeak.frequency)})`;
                document.getElementById('fundamental-freq').textContent = 
                    `${analysis.peaks[analysis.peaks.length - 1].frequency} Hz`;
            } else {
                document.getElementById('dominant-freq').textContent = '--';
                document.getElementById('fundamental-freq').textContent = '--';
            }
            
            let complexity = 'Niedrig';
            if (analysis.complexity > 10) complexity = 'Hoch';
            else if (analysis.complexity > 5) complexity = 'Mittel';
            document.getElementById('spectrum-complexity').textContent = complexity;
        }

        function displayXiRatios(xiRatios) {
            const list = document.getElementById('xi-ratios-list');
            list.innerHTML = '';
            
            if (!xiRatios || xiRatios.length === 0) {
                list.innerHTML = '<li>Keine Œæ-Verh√§ltnisse berechnet</li>';
                return;
            }
            
            const musicalRatios = [
                {value: 2.0, name: 'Oktave'},
                {value: 1.5, name: 'Quinte'},
                {value: 1.25, name: 'Gro√üe Terz'},
                {value: 1.2, name: 'Kleine Terz'},
                {value: 1.33, name: 'Quarte'},
                {value: 3.0, name: 'Duodezime'},
                {value: 4.0, name: 'Doppel-Oktave'}
            ];
            
            xiRatios.slice(0, 10).forEach(ratio => {
                const li = document.createElement('li');
                const xiValue = ratio.xiRatioFloat;
                
                let musical = '';
                for (const mr of musicalRatios) {
                    if (Math.abs(xiValue - mr.value) < 0.1) {
                        musical = ` (‚âà ${mr.name})`;
                        break;
                    }
                }
                
                li.textContent = `Œæ(${ratio.freqHigh}/${ratio.freqLow}) = ${xiValue.toFixed(2)}${musical}`;
                list.appendChild(li);
            });
        }

        // Visualisierung
        function plotSpectrum(peaks, expectedFreqs = []) {
            const canvas = document.getElementById('musicCanvas');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            ctx.clearRect(0, 0, width, height);
            
            if (!peaks || peaks.length === 0) return;
            
            // Zeichne Raster
            ctx.strokeStyle = '#34495e';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 10; i++) {
                const x = (width / 10) * i;
                const y = (height / 5) * i;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            const maxFreq = Math.max(2000, Math.max(...peaks.map(p => p.frequency)) * 1.2);
            const maxMag = Math.max(...peaks.map(p => p.magnitude));
            
            // Zeichne erwartete Frequenzen
            ctx.strokeStyle = '#27ae60';
            ctx.lineWidth = 2;
            expectedFreqs.forEach(freq => {
                const x = (freq / maxFreq) * width;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
            });
            
            // Zeichne Peaks
            peaks.forEach((peak, index) => {
                const x = (peak.frequency / maxFreq) * width;
                const barHeight = (peak.magnitude / maxMag) * height * 0.8;
                const y = height - barHeight;
                
                const isExpected = expectedFreqs.some(f => Math.abs(f - peak.frequency) < 10);
                ctx.fillStyle = isExpected ? '#2ecc71' : '#3498db';
                
                ctx.fillRect(x - 3, y, 6, barHeight);
                
                ctx.fillStyle = '#2c3e50';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                if (barHeight > 20) {
                    ctx.fillText(peak.frequency + 'Hz', x, y - 5);
                    ctx.fillText(getNoteName(peak.frequency), x, y - 18);
                }
            });
        }

        // Preset-Funktionen
        function loadPreset(type) {
            switch(type) {
                case 'perfect-fifth':
                    document.getElementById('interval-root').value = '440.00';
                    document.getElementById('interval-type').value = '1.5';
                    updateIntervalDisplay();
                    analyzeInterval();
                    break;
                    
                case 'major-triad':
                    document.getElementById('chord-root').value = '261.63';
                    document.getElementById('chord-type').value = 'major';
                    updateChordDisplay();
                    analyzeChord();
                    break;
                    
                case 'minor-triad':
                    document.getElementById('chord-root').value = '440.00';
                    document.getElementById('chord-type').value = 'minor';
                    updateChordDisplay();
                    analyzeChord();
                    break;
                    
                case 'octaves':
                    document.getElementById('fundamental').value = '220';
                    document.getElementById('harmonics-count').value = '4';
                    updateHarmonicsDisplay();
                    analyzeHarmonics();
                    break;
                    
                case 'power-chord':
                    document.getElementById('chord-root').value = '329.63';
                    document.getElementById('chord-type').value = 'power';
                    updateChordDisplay();
                    analyzeChord();
                    break;
                    
                case 'bach-chord':
                    const bachSignal = XiSignal.create([261.63, 329.63, 392.00, 523.25], [0.8, 0.7, 0.6, 0.5], 2.0, 1000);
                    analyzeMusicalSignal(bachSignal, [261.63, 329.63, 392.00, 523.25]);
                    break;
                    
                case 'just-intonation':
                    const justSignal = XiSignal.create([261.63, 327.04, 392.44], [0.8, 0.8, 0.8], 2.0, 1000);
                    analyzeMusicalSignal(justSignal, [261.63, 327.04, 392.44]);
                    break;
                    
                case 'equal-temperament':
                    const equalSignal = XiSignal.create([261.63, 329.63, 392.00], [0.8, 0.8, 0.8], 2.0, 1000);
                    analyzeMusicalSignal(equalSignal, [261.63, 329.63, 392.00]);
                    break;
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('interval-root').addEventListener('change', updateIntervalDisplay);
            document.getElementById('interval-type').addEventListener('change', updateIntervalDisplay);
            document.getElementById('chord-root').addEventListener('change', updateChordDisplay);
            document.getElementById('chord-type').addEventListener('change', updateChordDisplay);
            document.getElementById('fundamental').addEventListener('change', updateHarmonicsDisplay);
            document.getElementById('harmonics-count').addEventListener('change', updateHarmonicsDisplay);
            
            updateIntervalDisplay();
            updateChordDisplay();
            updateHarmonicsDisplay();
            
            console.log('Musikalische Œæ-FFT Demo bereit!');
        });
    </script>
</body>
</html>