<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ξ-FFT Drei-Ton Tuner mit Schwebungsmessung</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: calc(100vh - 40px);
        }

        .controls-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .spectrum-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8em;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .source-selector {
            margin-bottom: 20px;
        }

        .source-selector label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .source-selector select, .source-selector input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 14px;
        }

        .tone-display {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .tone-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 15px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tone-card.strongest {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .tone-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .tone-value {
            background: rgba(0, 0, 0, 0.3);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-family: 'Courier New', monospace;
        }

        .tone-note {
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
        }

        .tone-freq {
            font-size: 16px;
            color: #87ceeb;
        }

        .tone-amplitude {
            font-size: 14px;
            color: #98fb98;
        }

        .tone-deviation {
            font-size: 14px;
            color: #ff6b6b;
        }

        .beat-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .beat-value {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .beat-freq {
            font-family: 'Courier New', monospace;
            font-size: 18px;
            color: #ffd700;
        }

        .spectrum-canvas {
            width: 100%;
            height: 400px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .spectrum-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            gap: 10px;
        }

        .range-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .range-control label {
            font-size: 12px;
            color: #ccc;
        }

        .range-control span {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #ffd700;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff6b6b;
            transition: background 0.3s ease;
        }

        .status-indicator.active {
            background: #98fb98;
            box-shadow: 0 0 10px rgba(152, 251, 152, 0.5);
        }

        .control-button {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .control-button:hover {
            transform: translateY(-2px);
        }

        .control-button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls-panel">
            <h1>ξ-FFT Drei-Ton Tuner</h1>
            
            <div class="status-bar">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="status-indicator" id="statusIndicator"></div>
                    <span id="statusText">Bereit</span>
                </div>
                <span id="sampleRate">Sample Rate: 44100 Hz</span>
            </div>

            <div class="source-selector">
                <label for="audioSource">Audio-Quelle:</label>
                <select id="audioSource">
                    <option value="microphone">Mikrofon</option>
                    <option value="file">Audio-Datei</option>
                </select>
                <input type="file" id="audioFile" accept="audio/*" style="display: none; margin-top: 10px;">
                <button class="control-button" id="startStopBtn">Start</button>
            </div>

            <div class="tone-display">
                <div class="tone-card" id="tone1">
                    <div class="tone-info">
                        <div class="tone-value tone-note" id="note1">-</div>
                        <div class="tone-value tone-freq" id="freq1">0.0 Hz</div>
                        <div class="tone-value tone-amplitude" id="amp1">0.0%</div>
                        <div class="tone-value tone-deviation" id="dev1">±0 Cent</div>
                    </div>
                </div>

                <div class="tone-card" id="tone2">
                    <div class="tone-info">
                        <div class="tone-value tone-note" id="note2">-</div>
                        <div class="tone-value tone-freq" id="freq2">0.0 Hz</div>
                        <div class="tone-value tone-amplitude" id="amp2">0.0%</div>
                        <div class="tone-value tone-deviation" id="dev2">±0 Cent</div>
                    </div>
                </div>

                <div class="tone-card" id="tone3">
                    <div class="tone-info">
                        <div class="tone-value tone-note" id="note3">-</div>
                        <div class="tone-value tone-freq" id="freq3">0.0 Hz</div>
                        <div class="tone-value tone-amplitude" id="amp3">0.0%</div>
                        <div class="tone-value tone-deviation" id="dev3">±0 Cent</div>
                    </div>
                </div>

                <div class="beat-info">
                    <h3 style="margin-bottom: 10px;">Schwebungen</h3>
                    <div class="beat-value">
                        <span>Ton 1-2:</span>
                        <span class="beat-freq" id="beat12">0.0 Hz (0 Cent/s)</span>
                    </div>
                    <div class="beat-value">
                        <span>Ton 1-3:</span>
                        <span class="beat-freq" id="beat13">0.0 Hz (0 Cent/s)</span>
                    </div>
                    <div class="beat-value">
                        <span>Ton 2-3:</span>
                        <span class="beat-freq" id="beat23">0.0 Hz (0 Cent/s)</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="spectrum-panel">
            <h2 style="margin-bottom: 15px;">Spektrum-Anzeige</h2>
            <canvas id="spectrumCanvas" class="spectrum-canvas"></canvas>
            <div class="spectrum-controls">
                <div class="range-control">
                    <label>Min Freq</label>
                    <span id="minFreqDisplay">20 Hz</span>
                </div>
                <div class="range-control">
                    <label>Max Freq</label>
                    <span id="maxFreqDisplay">2000 Hz</span>
                </div>
                <div class="range-control">
                    <label>Auflösung</label>
                    <span id="resolutionDisplay">1.0 Hz</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ξ-FFT Library einbetten (vereinfachte Version für den Tuner)
        class XiFFT {
            constructor(sampleRate, threshold = 0.02) {
                this.sampleRate = sampleRate;
                this.threshold = Math.floor(threshold * 1000);
                this.version = '1.0.0';
            }

            analyze(signal, freqRange = [20, 2000]) {
                if (!Array.isArray(signal) || signal.length === 0) {
                    throw new Error('Signal muss ein nicht-leeres Array sein');
                }

                const peaks = this.findSpectralPeaks(signal, freqRange);
                const signalStats = this.calculateSignalStats(signal);

                return {
                    peaks: peaks,
                    peakCount: peaks.length,
                    signalStats: signalStats,
                    analysisTime: Date.now(),
                    version: this.version
                };
            }

            findSpectralPeaks(signal, freqRange) {
                const peaks = [];
                const [minFreq, maxFreq] = freqRange;
                const stepSize = Math.max(0.5, (maxFreq - minFreq) / 2000); // Adaptive Auflösung

                for (let freq = minFreq; freq <= maxFreq; freq += stepSize) {
                    const magnitude = this.calculateMagnitude(signal, freq);
                    
                    if (magnitude > this.threshold) {
                        peaks.push({
                            frequency: freq,
                            magnitude: magnitude,
                            magnitudeFloat: magnitude / 1000.0
                        });
                    }
                }

                return peaks.sort((a, b) => b.magnitude - a.magnitude);
            }

            calculateMagnitude(signal, frequency) {
                const N = signal.length;
                let real = 0;
                let imag = 0;

                for (let n = 0; n < N; n++) {
                    const angle = -2 * Math.PI * frequency * n / this.sampleRate;
                    const cosVal = Math.cos(angle);
                    const sinVal = Math.sin(angle);
                    
                    real += (signal[n] / 1000.0) * cosVal;
                    imag += (signal[n] / 1000.0) * sinVal;
                }

                const magnitude = Math.sqrt(real * real + imag * imag) * 2 / N;
                return Math.floor(magnitude * 1000);
            }

            calculateSignalStats(signal) {
                let sum = 0;
                let sumSquares = 0;
                let minVal = signal[0];
                let maxVal = signal[0];

                for (let i = 0; i < signal.length; i++) {
                    const val = signal[i];
                    sum += val;
                    sumSquares += Math.floor((val * val) / 1000);
                    if (val < minVal) minVal = val;
                    if (val > maxVal) maxVal = val;
                }

                const mean = Math.floor(sum / signal.length);
                const rms = Math.floor(Math.sqrt(Math.max(0, Math.floor(sumSquares / signal.length))));

                return {
                    mean: mean,
                    meanFloat: mean / 1000.0,
                    rms: rms,
                    rmsFloat: rms / 1000.0,
                    min: minVal,
                    max: maxVal,
                    range: maxVal - minVal,
                    sampleCount: signal.length
                };
            }
        }

        // Tuner-Hauptklasse
        class ThreeToneTuner {
            constructor() {
                this.audioContext = null;
                this.analyzer = null;
                this.source = null;
                this.xiFFT = null;
                this.isRunning = false;
                this.animationFrame = null;
                this.tones = [null, null, null];
                this.canvas = document.getElementById('spectrumCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.setupCanvas();
                this.setupEventListeners();
                
                // Noten-Mapping
                this.noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'H'];
                this.A4_FREQ = 440.0;
            }

            setupCanvas() {
                const dpr = window.devicePixelRatio || 1;
                const rect = this.canvas.getBoundingClientRect();
                this.canvas.width = rect.width * dpr;
                this.canvas.height = rect.height * dpr;
                this.ctx.scale(dpr, dpr);
                this.canvas.style.width = rect.width + 'px';
                this.canvas.style.height = rect.height + 'px';
            }

            setupEventListeners() {
                document.getElementById('audioSource').addEventListener('change', (e) => {
                    const fileInput = document.getElementById('audioFile');
                    if (e.target.value === 'file') {
                        fileInput.style.display = 'block';
                    } else {
                        fileInput.style.display = 'none';
                    }
                });

                document.getElementById('startStopBtn').addEventListener('click', () => {
                    if (this.isRunning) {
                        this.stop();
                    } else {
                        this.start();
                    }
                });

                document.getElementById('audioFile').addEventListener('change', (e) => {
                    if (e.target.files[0]) {
                        this.loadAudioFile(e.target.files[0]);
                    }
                });

                window.addEventListener('resize', () => {
                    this.setupCanvas();
                });
            }

            async start() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    const sourceType = document.getElementById('audioSource').value;
                    
                    if (sourceType === 'microphone') {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        this.source = this.audioContext.createMediaStreamSource(stream);
                    } else if (sourceType === 'file') {
                        const fileInput = document.getElementById('audioFile');
                        if (!fileInput.files[0]) {
                            alert('Bitte wählen Sie eine Audio-Datei aus.');
                            return;
                        }
                        // Audio-Datei wird separat behandelt
                        return;
                    }

                    this.analyzer = this.audioContext.createAnalyser();
                    this.analyzer.fftSize = 8192;
                    this.analyzer.smoothingTimeConstant = 0.1;
                    
                    this.source.connect(this.analyzer);
                    
                    this.xiFFT = new XiFFT(this.audioContext.sampleRate, 0.001);
                    
                    this.isRunning = true;
                    this.updateStatus('Aktiv', true);
                    document.getElementById('startStopBtn').textContent = 'Stop';
                    document.getElementById('sampleRate').textContent = `Sample Rate: ${this.audioContext.sampleRate} Hz`;
                    
                    this.analyzeLoop();
                } catch (error) {
                    console.error('Fehler beim Starten:', error);
                    this.updateStatus('Fehler: ' + error.message, false);
                }
            }

            stop() {
                this.isRunning = false;
                if (this.animationFrame) {
                    cancelAnimationFrame(this.animationFrame);
                }
                if (this.audioContext) {
                    this.audioContext.close();
                }
                this.updateStatus('Gestoppt', false);
                document.getElementById('startStopBtn').textContent = 'Start';
                this.clearDisplay();
            }

            async loadAudioFile(file) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);
                    
                    this.source = this.audioContext.createBufferSource();
                    this.source.buffer = audioBuffer;
                    this.source.loop = true;
                    
                    this.analyzer = this.audioContext.createAnalyser();
                    this.analyzer.fftSize = 8192;
                    this.analyzer.smoothingTimeConstant = 0.1;
                    
                    this.source.connect(this.analyzer);
                    this.analyzer.connect(this.audioContext.destination);
                    this.source.start();
                    
                    this.xiFFT = new XiFFT(this.audioContext.sampleRate, 0.001);
                    
                    this.isRunning = true;
                    this.updateStatus('Audio-Datei aktiv', true);
                    document.getElementById('startStopBtn').textContent = 'Stop';
                    document.getElementById('sampleRate').textContent = `Sample Rate: ${this.audioContext.sampleRate} Hz`;
                    
                    this.analyzeLoop();
                } catch (error) {
                    console.error('Fehler beim Laden der Audio-Datei:', error);
                    this.updateStatus('Fehler beim Laden der Datei', false);
                }
            }

            analyzeLoop() {
                if (!this.isRunning) return;

                const bufferLength = this.analyzer.frequencyBinCount;
                const dataArray = new Float32Array(bufferLength);
                this.analyzer.getFloatTimeDomainData(dataArray);

                // Konvertiere zu Integer-Array für ξ-FFT
                const intSignal = Array.from(dataArray).map(x => Math.floor(x * 1000));

                // Finde die stärksten drei Töne
                this.findThreeStrongestTones(intSignal);
                
                // Zeichne Spektrum
                this.drawSpectrum(intSignal);

                this.animationFrame = requestAnimationFrame(() => this.analyzeLoop());
            }

            findThreeStrongestTones(signal) {
                // Dynamischer Frequenzbereich basierend auf den erkannten Tönen
                let freqRange = [20, 2000];
                
                if (this.tones.some(t => t !== null)) {
                    const frequencies = this.tones.filter(t => t !== null).map(t => t.frequency);
                    if (frequencies.length > 0) {
                        const minF = Math.min(...frequencies);
                        const maxF = Math.max(...frequencies);
                        const range = maxF - minF;
                        freqRange = [
                            Math.max(20, minF - range * 0.5),
                            Math.min(8000, maxF + range * 0.5)
                        ];
                    }
                }

                const result = this.xiFFT.analyze(signal, freqRange);
                
                // Filtere Obertöne heraus
                const fundamentals = this.filterHarmonics(result.peaks);
                
                // Nehme die drei stärksten Grundtöne
                const topThree = fundamentals.slice(0, 3);
                
                // Aktualisiere Ton-Anzeigen
                for (let i = 0; i < 3; i++) {
                    if (i < topThree.length) {
                        this.tones[i] = topThree[i];
                        this.updateToneDisplay(i + 1, topThree[i]);
                    } else {
                        this.tones[i] = null;
                        this.clearToneDisplay(i + 1);
                    }
                }

                // Finde stärksten Ton und markiere ihn
                this.highlightStrongestTone();
                
                // Berechne Schwebungen
                this.calculateBeats();

                // Aktualisiere Spektrum-Bereich
                this.updateSpectrumRange(freqRange);
            }

            filterHarmonics(peaks) {
                const fundamentals = [];
                const tolerance = 0.02; // 2% Toleranz

                for (const peak of peaks) {
                    let isHarmonic = false;
                    
                    for (const fundamental of fundamentals) {
                        const ratio = peak.frequency / fundamental.frequency;
                        const nearestInteger = Math.round(ratio);
                        
                        if (nearestInteger >= 2 && Math.abs(ratio - nearestInteger) < tolerance) {
                            isHarmonic = true;
                            break;
                        }
                    }
                    
                    if (!isHarmonic) {
                        fundamentals.push(peak);
                    }
                }

                return fundamentals;
            }

            frequencyToNote(frequency) {
                const A4 = 440.0;
                const noteNumber = Math.round(12 * Math.log2(frequency / A4));
                const octave = Math.floor((noteNumber + 9) / 12) + 4;
                const noteIndex = ((noteNumber % 12) + 12) % 12;
                const noteName = this.noteNames[noteIndex];
                
                const expectedFreq = A4 * Math.pow(2, noteNumber / 12);
                const cents = Math.round(1200 * Math.log2(frequency / expectedFreq));
                
                return {
                    name: noteName + octave,
                    cents: cents,
                    expectedFreq: expectedFreq
                };
            }

            updateToneDisplay(toneNumber, tone) {
                const noteInfo = this.frequencyToNote(tone.frequency);
                
                document.getElementById(`note${toneNumber}`).textContent = noteInfo.name;
                document.getElementById(`freq${toneNumber}`).textContent = `${tone.frequency.toFixed(1)} Hz`;
                document.getElementById(`amp${toneNumber}`).textContent = `${(tone.magnitudeFloat * 100).toFixed(1)}%`;
                
                const centsDisplay = noteInfo.cents >= 0 ? `+${noteInfo.cents}` : `${noteInfo.cents}`;
                document.getElementById(`dev${toneNumber}`).textContent = `${centsDisplay} Cent`;
                
                // Farbe basierend auf Abweichung
                const devElement = document.getElementById(`dev${toneNumber}`);
                if (Math.abs(noteInfo.cents) <= 5) {
                    devElement.style.color = '#98fb98'; // Grün - in tune
                } else if (Math.abs(noteInfo.cents) <= 20) {
                    devElement.style.color = '#ffd700'; // Gelb - leicht verstimmt
                } else {
                    devElement.style.color = '#ff6b6b'; // Rot - stark verstimmt
                }
            }

            clearToneDisplay(toneNumber) {
                document.getElementById(`note${toneNumber}`).textContent = '-';
                document.getElementById(`freq${toneNumber}`).textContent = '0.0 Hz';
                document.getElementById(`amp${toneNumber}`).textContent = '0.0%';
                document.getElementById(`dev${toneNumber}`).textContent = '±0 Cent';
                document.getElementById(`dev${toneNumber}`).style.color = '#ff6b6b';
            }

            highlightStrongestTone() {
                // Entferne alle Hervorhebungen
                for (let i = 1; i <= 3; i++) {
                    document.getElementById(`tone${i}`).classList.remove('strongest');
                }

                // Finde stärksten Ton
                let strongestIndex = -1;
                let maxMagnitude = 0;

                for (let i = 0; i < 3; i++) {
                    if (this.tones[i] && this.tones[i].magnitudeFloat > maxMagnitude) {
                        maxMagnitude = this.tones[i].magnitudeFloat;
                        strongestIndex = i;
                    }
                }

                // Hebe stärksten Ton hervor
                if (strongestIndex >= 0) {
                    document.getElementById(`tone${strongestIndex + 1}`).classList.add('strongest');
                }
            }

            calculateBeats() {
                const validTones = this.tones.filter(t => t !== null);
                
                if (validTones.length >= 2) {
                    const beat12 = Math.abs(validTones[0].frequency - validTones[1].frequency);
                    const cents12 = beat12 * 1200 / ((validTones[0].frequency + validTones[1].frequency) / 2);
                    document.getElementById('beat12').textContent = `${beat12.toFixed(2)} Hz (${cents12.toFixed(1)} Cent/s)`;
                } else {
                    document.getElementById('beat12').textContent = '0.0 Hz (0 Cent/s)';
                }

                if (validTones.length >= 3) {
                    const beat13 = Math.abs(validTones[0].frequency - validTones[2].frequency);
                    const cents13 = beat13 * 1200 / ((validTones[0].frequency + validTones[2].frequency) / 2);
                    document.getElementById('beat13').textContent = `${beat13.toFixed(2)} Hz (${cents13.toFixed(1)} Cent/s)`;
                    
                    const beat23 = Math.abs(validTones[1].frequency - validTones[2].frequency);
                    const cents23 = beat23 * 1200 / ((validTones[1].frequency + validTones[2].frequency) / 2);
                    document.getElementById('beat23').textContent = `${beat23.toFixed(2)} Hz (${cents23.toFixed(1)} Cent/s)`;
                } else {
                    document.getElementById('beat13').textContent = '0.0 Hz (0 Cent/s)';
                    document.getElementById('beat23').textContent = '0.0 Hz (0 Cent/s)';
                }
            }

            updateSpectrumRange(freqRange) {
                document.getElementById('minFreqDisplay').textContent = `${Math.round(freqRange[0])} Hz`;
                document.getElementById('maxFreqDisplay').textContent = `${Math.round(freqRange[1])} Hz`;
                
                const resolution = (freqRange[1] - freqRange[0]) / 1000;
                document.getElementById('resolutionDisplay').textContent = `${resolution.toFixed(1)} Hz`;
            }

            drawSpectrum(signal) {
                const rect = this.canvas.getBoundingClientRect();
                const width = rect.width;
                const height = rect.height;
                
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                this.ctx.fillRect(0, 0, width, height);

                if (!this.xiFFT) return;

                // Bestimme Frequenzbereich
                let freqRange = [20, 2000];
                const validTones = this.tones.filter(t => t !== null);
                if (validTones.length > 0) {
                    const frequencies = validTones.map(t => t.frequency);
                    const minF = Math.min(...frequencies);
                    const maxF = Math.max(...frequencies);
                    const range = maxF - minF || 100;
                    freqRange = [
                        Math.max(20, minF - range * 1.5),
                        Math.min(8000, maxF + range * 1.5)
                    ];
                }

                // Berechne Spektrum
                const result = this.xiFFT.analyze(signal, freqRange);
                const peaks = result.peaks;

                if (peaks.length === 0) return;

                // Zeichne Spektrum
                this.ctx.strokeStyle = '#4facfe';
                this.ctx.lineWidth = 1;
                this.ctx.beginPath();

                const maxMagnitude = Math.max(...peaks.map(p => p.magnitudeFloat));
                
                for (let i = 0; i < peaks.length; i++) {
                    const x = (peaks[i].frequency - freqRange[0]) / (freqRange[1] - freqRange[0]) * width;
                    const y = height - (peaks[i].magnitudeFloat / maxMagnitude) * height * 0.8;
                    
                    if (i === 0) {
                        this.ctx.moveTo(x, y);
                    } else {
                        this.ctx.lineTo(x, y);
                    }
                }
                this.ctx.stroke();

                // Markiere die drei erkannten Töne
                this.ctx.strokeStyle = '#ffd700';
                this.ctx.lineWidth = 3;
                
                for (const tone of this.tones) {
                    if (tone) {
                        const x = (tone.frequency - freqRange[0]) / (freqRange[1] - freqRange[0]) * width;
                        const y = height - (tone.magnitudeFloat / maxMagnitude) * height * 0.8;
                        
                        this.ctx.beginPath();
                        this.ctx.moveTo(x, height);
                        this.ctx.lineTo(x, y);
                        this.ctx.stroke();
                        
                        // Frequenz-Label
                        this.ctx.fillStyle = '#ffd700';
                        this.ctx.font = '12px Arial';
                        this.ctx.fillText(`${tone.frequency.toFixed(1)} Hz`, x + 5, y - 5);
                    }
                }
            }

            updateStatus(text, isActive) {
                document.getElementById('statusText').textContent = text;
                const indicator = document.getElementById('statusIndicator');
                if (isActive) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            }

            clearDisplay() {
                for (let i = 1; i <= 3; i++) {
                    this.clearToneDisplay(i);
                    document.getElementById(`tone${i}`).classList.remove('strongest');
                }
                
                document.getElementById('beat12').textContent = '0.0 Hz (0 Cent/s)';
                document.getElementById('beat13').textContent = '0.0 Hz (0 Cent/s)';
                document.getElementById('beat23').textContent = '0.0 Hz (0 Cent/s)';
                
                // Lösche Spektrum
                const rect = this.canvas.getBoundingClientRect();
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                this.ctx.fillRect(0, 0, rect.width, rect.height);
            }
        }

        // Initialisiere Tuner
        const tuner = new ThreeToneTuner();
    </script>
</body>
</html>